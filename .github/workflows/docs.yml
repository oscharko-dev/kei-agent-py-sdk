# GitHub Actions Workflow fÃ¼r KEI-Agent Python SDK Dokumentation
# Automatisiert das Erstellen und Deployen der MkDocs-Dokumentation

name: ğŸ“š Documentation

on:
  # Trigger bei Push auf main Branch
  push:
    branches: [ main, master ]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '*.py'
      - 'README.md'
      - '.github/workflows/docs.yml'

  # Trigger bei Pull Requests
  pull_request:
    branches: [ main, master ]
    paths:
      - 'docs/**'
      - 'mkdocs.yml'
      - '*.py'
      - 'README.md'
      - '.github/workflows/docs.yml'

  # Manueller Trigger
  workflow_dispatch:
    inputs:
      deploy_to_pages:
        description: 'Deploy to GitHub Pages'
        required: false
        default: 'true'
        type: boolean

# Berechtigungen fÃ¼r GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Verhindert gleichzeitige Deployments
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Job 1: Dokumentation erstellen
  build-docs:
    name: ğŸ”¨ Build Documentation
    runs-on: ubuntu-latest

    steps:
      # Repository auschecken
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # VollstÃ¤ndige Historie fÃ¼r git-revision-date-localized

      # Python Setup
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # Dependencies installieren
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[docs]"

      # Dokumentation validieren
      - name: âœ… Validate Documentation
        run: |
          echo "ğŸ” Validiere MkDocs-Konfiguration..."
          mkdocs build --strict --verbose

          echo "ğŸ“Š Dokumentations-Statistiken:"
          find docs -name "*.md" | wc -l | xargs echo "Markdown-Dateien:"
          find site -name "*.html" | wc -l | xargs echo "Generierte HTML-Dateien:"

          echo "ğŸ”— PrÃ¼fe interne Links..."
          # Einfache Link-Validierung
          grep -r "\[.*\](.*\.md)" docs/ || echo "Keine internen Markdown-Links gefunden"

      # API-Dokumentation generieren
      - name: ğŸ“– Generate API Documentation
        run: |
          echo "ğŸ”§ Generiere API-Dokumentation aus Docstrings..."
          python -c "
          import pkgutil
          import importlib
          import inspect

          # Alle Module des Pakets finden
          modules = []
          for importer, modname, ispkg in pkgutil.iter_modules(['.'], ''):
              if modname.endswith('.py') or not modname.startswith('test_'):
                  modules.append(modname)

          print(f'Gefundene Module: {len(modules)}')
          for module in modules[:5]:  # Erste 5 anzeigen
              print(f'  - {module}')
          "

      # Dokumentation erstellen
      - name: ğŸ—ï¸ Build Documentation
        run: |
          echo "ğŸš€ Erstelle finale Dokumentation..."
          mkdocs build --clean --verbose

          # Build-Informationen hinzufÃ¼gen
          echo "Build-Zeit: $(date)" > site/build-info.txt
          echo "Git-Commit: ${{ github.sha }}" >> site/build-info.txt
          echo "Branch: ${{ github.ref_name }}" >> site/build-info.txt

      # Build-Artefakte hochladen
      - name: ğŸ“¤ Upload Documentation Artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation-site
          path: site/
          retention-days: 30

      # GitHub Pages Setup (nur bei main/master)
      - name: ğŸ”§ Setup Pages
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: actions/configure-pages@v5

      # Pages-Artefakt hochladen
      - name: ğŸ“¤ Upload Pages Artifact
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: actions/upload-pages-artifact@v3
        with:
          path: site/

  # Job 2: Zu GitHub Pages deployen
  deploy-pages:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-docs
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ğŸŒ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Job 3: Dokumentations-QualitÃ¤t prÃ¼fen
  quality-check:
    name: ğŸ” Documentation Quality Check
    runs-on: ubuntu-latest
    needs: build-docs

    steps:
      # Repository auschecken
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      # Python Setup
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Dokumentations-Artefakt herunterladen
      - name: ğŸ“¥ Download Documentation
        uses: actions/download-artifact@v4
        with:
          name: documentation-site
          path: site/

      # QualitÃ¤tsprÃ¼fungen
      - name: ğŸ” Quality Checks
        run: |
          echo "ğŸ“Š Dokumentations-QualitÃ¤tsprÃ¼fung..."

          # DateigrÃ¶ÃŸe prÃ¼fen
          site_size=$(du -sh site/ | cut -f1)
          echo "ğŸ“ Dokumentations-GrÃ¶ÃŸe: $site_size"

          # HTML-Validierung (einfach)
          echo "ğŸ” HTML-Struktur prÃ¼fen..."
          find site -name "*.html" -exec grep -l "<html" {} \; | wc -l | xargs echo "GÃ¼ltige HTML-Dateien:"

          # Broken Links prÃ¼fen (einfach)
          echo "ğŸ”— Interne Links prÃ¼fen..."
          find site -name "*.html" -exec grep -l "href.*404" {} \; | wc -l | xargs echo "Potentielle 404-Links:"

          # CSS/JS Dateien prÃ¼fen
          echo "ğŸ¨ Asset-Dateien prÃ¼fen..."
          find site -name "*.css" | wc -l | xargs echo "CSS-Dateien:"
          find site -name "*.js" | wc -l | xargs echo "JavaScript-Dateien:"

          # Suchindex prÃ¼fen
          if [ -f "site/search/search_index.json" ]; then
            echo "ğŸ” Suchindex gefunden und validiert"
          else
            echo "âš ï¸ Suchindex nicht gefunden"
          fi

          echo "âœ… QualitÃ¤tsprÃ¼fung abgeschlossen"

  # Job 4: Dokumentations-Metriken
  metrics:
    name: ğŸ“ˆ Documentation Metrics
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      # Repository auschecken
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # Python Setup
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Metriken sammeln
      - name: ğŸ“Š Collect Documentation Metrics
        run: |
          echo "ğŸ“ˆ Sammle Dokumentations-Metriken..."

          # Markdown-Dateien zÃ¤hlen
          md_files=$(find docs -name "*.md" | wc -l)
          echo "ğŸ“„ Markdown-Dateien: $md_files"

          # WÃ¶rter zÃ¤hlen
          word_count=$(find docs -name "*.md" -exec wc -w {} + | tail -1 | awk '{print $1}')
          echo "ğŸ“ Gesamte WÃ¶rter: $word_count"

          # Zeilen zÃ¤hlen
          line_count=$(find docs -name "*.md" -exec wc -l {} + | tail -1 | awk '{print $1}')
          echo "ğŸ“ Gesamte Zeilen: $line_count"

          # Python-Module mit Docstrings
          python_files=$(find . -name "*.py" -not -path "./tests/*" | wc -l)
          echo "ğŸ Python-Module: $python_files"

          # Git-Statistiken
          last_commit=$(git log -1 --format="%h - %s (%cr)")
          echo "ğŸ“ Letzter Commit: $last_commit"

          # Metriken in Datei speichern
          cat > docs-metrics.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "markdown_files": $md_files,
            "word_count": $word_count,
            "line_count": $line_count,
            "python_files": $python_files,
            "last_commit": "$last_commit"
          }
          EOF

          echo "ğŸ“Š Metriken gespeichert in docs-metrics.json"
          cat docs-metrics.json

      # Metriken als Artefakt speichern
      - name: ğŸ“¤ Upload Metrics
        uses: actions/upload-artifact@v4
        with:
          name: documentation-metrics
          path: docs-metrics.json
          retention-days: 90
