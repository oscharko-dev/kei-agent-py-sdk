# GitHub Actions Workflow fÃ¼r KEI-Agent Python SDK Continuous Integration
# Automatisiert Tests, Code-QualitÃ¤t und Security-Checks mit Makefile-Integration

name: ğŸ”„ Continuous Integration

on:
  # Trigger bei Push auf main/master Branch
  push:
    branches: [ main, master, develop ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'
      - '.gitignore'
  
  # Trigger bei Pull Requests
  pull_request:
    branches: [ main, master, develop ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'LICENSE'
      - '.gitignore'
  
  # Manueller Trigger
  workflow_dispatch:
    inputs:
      run_performance_tests:
        description: 'Run performance tests'
        required: false
        default: false
        type: boolean
      python_version:
        description: 'Python version for manual run'
        required: false
        default: '3.11'
        type: choice
        options:
          - '3.8'
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'

# Berechtigungen
permissions:
  contents: read
  checks: write
  pull-requests: write

# Umgebungsvariablen
env:
  PYTHONUNBUFFERED: 1
  PYTHONDONTWRITEBYTECODE: 1
  PIP_NO_CACHE_DIR: 1
  PIP_DISABLE_PIP_VERSION_CHECK: 1

jobs:
  # Job 1: Code-QualitÃ¤t und Linting
  code-quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    
    steps:
      # Repository auschecken
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      # Python Setup
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # Dependencies installieren
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      # Ruff Linting
      - name: ğŸ” Ruff Linting
        run: |
          echo "ğŸ” FÃ¼hre Ruff Linting aus..."
          make lint
      
      # Ruff Formatting Check
      - name: ğŸ¨ Ruff Format Check
        run: |
          echo "ğŸ¨ PrÃ¼fe Code-Formatierung..."
          make format-check
      
      # MyPy Type Checking
      - name: ğŸ”¬ MyPy Type Checking
        run: |
          echo "ğŸ”¬ FÃ¼hre Type-Checking aus..."
          make type-check
      
      # Bandit Security Scan
      - name: ğŸ›¡ï¸ Security Scan
        run: |
          echo "ğŸ›¡ï¸ FÃ¼hre Security-Scan aus..."
          make security-scan
        continue-on-error: true  # Security-Warnungen sollen Build nicht stoppen
      
      # Upload Security Report
      - name: ğŸ“¤ Upload Security Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: bandit-report.json
          retention-days: 30

  # Job 2: Matrix Testing
  test-matrix:
    name: ğŸ§ª Test Matrix
    runs-on: ${{ matrix.os }}
    needs: code-quality
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
        exclude:
          # Windows und macOS nur fÃ¼r LTS-Versionen testen
          - os: windows-latest
            python-version: '3.9'
          - os: windows-latest
            python-version: '3.10'
          - os: macos-latest
            python-version: '3.9'
          - os: macos-latest
            python-version: '3.10'
    
    steps:
      # Repository auschecken
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      # Python Setup
      - name: ğŸ Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      # Dependencies installieren
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      # Schnelle Tests (Unit Tests)
      - name: ğŸš€ Fast Tests
        run: |
          echo "ğŸš€ FÃ¼hre schnelle Unit Tests aus..."
          make test-fast
      
      # Upload Test Results
      - name: ğŸ“¤ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            htmlcov/
            .coverage
            coverage.xml
          retention-days: 30

  # Job 3: Umfassende Tests (nur Ubuntu + Python 3.11)
  comprehensive-tests:
    name: ğŸ”¬ Comprehensive Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      # Repository auschecken
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      # Python Setup
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # Dependencies installieren
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,security]"
      
      # Unit Tests mit Coverage
      - name: ğŸ§ª Unit Tests
        run: |
          echo "ğŸ§ª FÃ¼hre Unit Tests mit Coverage aus..."
          make test-unit
      
      # Integration Tests
      - name: ğŸ”— Integration Tests
        run: |
          echo "ğŸ”— FÃ¼hre Integration Tests aus..."
          make test-integration
      
      # Protocol Tests
      - name: ğŸ“¡ Protocol Tests
        run: |
          echo "ğŸ“¡ FÃ¼hre Protocol Tests aus..."
          make test-protocol
      
      # Refactored Component Tests
      - name: ğŸ”„ Refactored Tests
        run: |
          echo "ğŸ”„ FÃ¼hre Refactored Component Tests aus..."
          make test-refactored
      
      # Security Tests
      - name: ğŸ›¡ï¸ Security Tests
        run: |
          echo "ğŸ›¡ï¸ FÃ¼hre Security Tests aus..."
          make test-security
      
      # Performance Tests (optional)
      - name: âš¡ Performance Tests
        if: github.event.inputs.run_performance_tests == 'true' || github.event_name == 'push'
        run: |
          echo "âš¡ FÃ¼hre Performance Tests aus..."
          make test-performance
        continue-on-error: true
      
      # Coverage Report generieren
      - name: ğŸ“Š Generate Coverage Report
        run: |
          echo "ğŸ“Š Generiere Coverage Report..."
          make coverage-report
      
      # Coverage zu Codecov hochladen
      - name: ğŸ“¤ Upload Coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      
      # Coverage HTML Report hochladen
      - name: ğŸ“¤ Upload Coverage HTML
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30

  # Job 4: Dependency Security Check
  dependency-security:
    name: ğŸ”’ Dependency Security
    runs-on: ubuntu-latest
    
    steps:
      # Repository auschecken
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      # Python Setup
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      # Safety Check fÃ¼r Dependencies
      - name: ğŸ”’ Safety Check
        run: |
          pip install safety
          echo "ğŸ”’ PrÃ¼fe Dependencies auf bekannte SicherheitslÃ¼cken..."
          safety check --json --output safety-report.json || true
          safety check || echo "âš ï¸ Sicherheitswarnungen gefunden"
      
      # Upload Safety Report
      - name: ğŸ“¤ Upload Safety Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: safety-report
          path: safety-report.json
          retention-days: 30

  # Job 5: Build Test
  build-test:
    name: ğŸ—ï¸ Build Test
    runs-on: ubuntu-latest
    needs: [test-matrix, comprehensive-tests]
    
    steps:
      # Repository auschecken
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
      
      # Python Setup
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # Dependencies installieren
      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      # Package Build testen
      - name: ğŸ—ï¸ Test Package Build
        run: |
          echo "ğŸ—ï¸ Teste Package Build..."
          make build
      
      # Build-Artefakte validieren
      - name: âœ… Validate Build Artifacts
        run: |
          echo "âœ… Validiere Build-Artefakte..."
          make check-build
      
      # Upload Build Artifacts
      - name: ğŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # Job 6: CI Summary
  ci-summary:
    name: ğŸ“‹ CI Summary
    runs-on: ubuntu-latest
    needs: [code-quality, test-matrix, comprehensive-tests, dependency-security, build-test]
    if: always()

    steps:
      # CI-Status zusammenfassen
      - name: ğŸ“‹ CI Summary
        run: |
          echo "ğŸ“‹ CI Pipeline Summary"
          echo "====================="
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Test Matrix: ${{ needs.test-matrix.result }}"
          echo "Comprehensive Tests: ${{ needs.comprehensive-tests.result }}"
          echo "Dependency Security: ${{ needs.dependency-security.result }}"
          echo "Build Test: ${{ needs.build-test.result }}"
          echo ""

          if [[ "${{ needs.code-quality.result }}" == "success" &&
                "${{ needs.test-matrix.result }}" == "success" &&
                "${{ needs.comprehensive-tests.result }}" == "success" &&
                "${{ needs.build-test.result }}" == "success" ]]; then
            echo "âœ… CI Pipeline erfolgreich abgeschlossen!"
            exit 0
          else
            echo "âŒ CI Pipeline fehlgeschlagen!"
            exit 1
          fi
